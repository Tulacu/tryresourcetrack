<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingress Portal Hack æ•¸æ“šè¿½è¹¤å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; line-height: 1.6; color: #333; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); }
        h1 { text-align: center; color: #4a5568; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1); }
        .section { margin-bottom: 40px; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); border-left: 5px solid #667eea; }
        .section h2 { color: #2d3748; margin-bottom: 20px; font-size: 1.8em; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; color: #4a5568; }
        input[type="number"], input[type="text"], input[type="password"], input[type="file"] { padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; }
        input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="file"]:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; margin-right: 10px; margin-bottom: 10px; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .data-table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; }
        .alert { padding: 15px; margin: 20px 0; border-radius: 8px; font-weight: bold; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .alert-success { background-color: #c6f6d5; color: #22543d; border: 1px solid #9ae6b4; }
        .alert-error { background-color: #fed7d7; color: #742a2a; border: 1px solid #fc8181; }
        .alert-warning { background-color: #fef7cd; color: #744210; border: 1px solid #f6e05e; }
        .auth-status { padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; }
        .auth-status.authenticated { background-color: #c6f6d5; color: #22543d; }
        .auth-status.not-authenticated { background-color: #fed7d7; color: #742a2a; }
        
        .content-wrapper { position: relative; transition: opacity 0.3s ease-in-out; }
        .content-wrapper.locked { opacity: 0.4; pointer-events: none; }
        .content-wrapper.locked::after {
            content: 'ğŸ”’ è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.5);
            color: #2d3748;
            display: grid;
            place-items: center;
            font-weight: bold;
            z-index: 10;
            border-radius: 15px;
            font-size: 1.2em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® Ingress Portal Hack æ•¸æ“šè¿½è¹¤å™¨</h1>
        
        <div class="section">
            <h2>ğŸ” èº«ä»½é©—è­‰</h2>
            <div class="auth-status not-authenticated" id="authStatus">âŒ æœªç™»å…¥</div>
            <div class="input-grid">
                <div class="input-group"><label for="username">å¸³è™Ÿ</label><input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ"></div>
                <div class="input-group"><label for="password">å¯†ç¢¼</label><input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></div>
            </div>
            <button onclick="login()" class="btn">ğŸ”‘ ç™»å…¥</button>
            <button onclick="logout()" class="btn">ğŸšª ç™»å‡º</button>
        </div>
        
        <div class="content-wrapper" id="mainContent">
            <div class="section" id="dataInputSection">
                <h2>ğŸ“ æ–°å¢ Hack æ•¸æ“š</h2>
                <div class="input-grid">
                    <div class="input-group"><label for="hackCount">Hackæ¬¡æ•¸</label><input type="number" id="hackCount" min="1" value="1"></div>
                    <div class="input-group"><label for="L7Res">L7 Resonator</label><input type="number" id="L7Res" min="0" value="0"></div>
                    <div class="input-group"><label for="L8Res">L8 Resonator</label><input type="number" id="L8Res" min="0" value="0"></div>
                    <div class="input-group"><label for="L7XMP">L7 XMP</label><input type="number" id="L7XMP" min="0" value="0"></div>
                    <div class="input-group"><label for="L8XMP">L8 XMP</label><input type="number" id="L8XMP" min="0" value="0"></div>
                    <div class="input-group"><label for="L7US">L7 Ultra Strike</label><input type="number" id="L7US" min="0" value="0"></div>
                    <div class="input-group"><label for="L8US">L8 Ultra Strike</label><input type="number" id="L8US" min="0" value="0"></div>
                    <div class="input-group"><label for="L7PC">L7 Power Cube</label><input type="number" id="L7PC" min="0" value="0"></div>
                    <div class="input-group"><label for="L8PC">L8 Power Cube</label><input type="number" id="L8PC" min="0" value="0"></div>
                    <div class="input-group"><label for="Cshield">Common Shield</label><input type="number" id="Cshield" min="0" value="0"></div>
                    <div class="input-group"><label for="Rshield">Rare Shield</label><input type="number" id="Rshield" min="0" value="0"></div>
                    <div class="input-group"><label for="VRShield">Very Rare Shield</label><input type="number" id="VRShield" min="0" value="0"></div>
                    <div class="input-group"><label for="AXAShield">AXA Shield</label><input type="number" id="AXAShield" min="0" value="0"></div>
                    <div class="input-group"><label for="Else">å…¶ä»–ç‰©å“</label><input type="number" id="Else" min="0" value="0"></div>
                    <div class="input-group"><label for="Cmod">Common Mod</label><input type="number" id="Cmod" min="0" value="0"></div>
                    <div class="input-group"><label for="Rmod">Rare Mod</label><input type="number" id="Rmod" min="0" value="0"></div>
                    <div class="input-group"><label for="VRmod">Very Rare Mod</label><input type="number" id="VRmod" min="0" value="0"></div>
                    <div class="input-group"><label for="Virus">Virus</label><input type="number" id="Virus" min="0" value="0"></div>
                </div>
                <button onclick="addHackData()" class="btn">â• æ–°å¢æ•¸æ“š</button>
            </div>
            
            <div class="section">
                <h2>ğŸ“Š çµ±è¨ˆæ‘˜è¦</h2>
                <div class="stats-grid" id="statsGrid"></div>
            </div>
            
            <div class="section">
                <h2>ğŸ“‹ è©³ç´°æ•¸æ“š</h2>
                <table class="data-table" id="dataTable">
                    <thead><tr><th>ç‰©è³‡åç¨±</th><th>ç¸½ç²å¾—é‡</th><th>ä½”ç¸½ç‰©è³‡æ¯”ä¾‹ (%)</th><th>å¹³å‡æ¯æ¬¡Hackç²å¾—é‡</th></tr></thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>

            <div class="section">
                <h2>â˜ï¸ åŒ¯å…¥æœ¬åœ° CSV</h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label for="csvFile">é¸æ“‡ CSV æª”æ¡ˆ</label>
                        <input type="file" id="csvFile" accept=".csv,.tsv,text/csv">
                    </div>
                </div>
                <button onclick="uploadLocalCSV()" class="btn">ğŸ“¤ ä¸Šå‚³ä¸¦è¼‰å…¥ CSV</button>
            </div>

            <div class="section">
                 <h2>âš™ï¸ GitHub åŒæ­¥è¨­å®š</h2>
                 <div class="input-grid">
                    <div class="input-group"><label for="githubRepo">GitHub Repository</label><input type="text" id="githubRepo" placeholder="username/repo-name"></div>
                    <div class="input-group"><label for="githubToken">GitHub Personal Access Token</label><input type="password" id="githubToken" placeholder="ghp_..."></div>
                    <div class="input-group"><label for="dataFileName">è³‡æ–™æª”æ¡ˆåç¨±</label><input type="text" id="dataFileName" value="ingress_hack_data.csv"></div>
                 </div>
                 <button onclick="saveGitHubConfig()" class="btn">ğŸ’¾ å„²å­˜è¨­å®š</button>
                 <button onclick="syncFromGitHub()" class="btn">ğŸ”„ å¾ GitHub åŒæ­¥</button>
                 <button onclick="uploadToGitHub()" class="btn">â˜ï¸ ä¸Šå‚³åˆ° GitHub</button>
            </div>

            <div class="section">
                <h2>ğŸ“ˆ ç‰©è³‡æ¯”ä¾‹åœ–</h2>
                <img src="/static/item_ratio_per_hack.png" alt="ç‰©è³‡æ¯”ä¾‹åœ–" style="max-width:100%;margin-bottom:20px;">
                <h2>ğŸ“‰ æ¯æ¬¡ Hack ç‰©è³‡åˆ†å¸ƒåœ–</h2>
                <img src="/static/total_items_per_hack.png" alt="æ¯æ¬¡ Hack ç‰©è³‡åˆ†å¸ƒåœ–" style="max-width:100%;">
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        const API_BASE_URL = 'https://tryresourcetrack.onrender.com';
        const itemColumns = ['L7Res', 'L8Res', 'L7XMP', 'L8XMP', 'L7US', 'L8US', 'L7PC', 'L8PC', 'Cshield', 'Rshield', 'VRShield', 'AXAShield', 'Else', 'Cmod', 'Rmod', 'VRmod', 'Virus'];
        const itemNames = { 
            'L7Res': 'L7 å…±æŒ¯å™¨', 'L8Res': 'L8 å…±æŒ¯å™¨', 'L7XMP': 'L7 XMP', 'L8XMP': 'L8 XMP', 
            'L7US': 'L7 è¶…æ“Š', 'L8US': 'L8 è¶…æ“Š', 'L7PC': 'L7 èƒ½é‡æ–¹å¡Š', 'L8PC': 'L8 èƒ½é‡æ–¹å¡Š', 
            'Cshield': 'æ™®é€šè­·ç›¾', 'Rshield': 'ç¨€æœ‰è­·ç›¾', 'VRShield': 'æ¥µç¨€æœ‰è­·ç›¾', 'AXAShield': 'AXA è­·ç›¾', 
            'Else': 'å…¶ä»–ç‰©å“', 'Cmod': 'æ™®é€šæ¨¡çµ„', 'Rmod': 'ç¨€æœ‰æ¨¡çµ„', 'VRmod': 'æ¥µç¨€æœ‰æ¨¡çµ„', 'Virus': 'ç—…æ¯’' 
        };
        let hackData = [];
        let chart = null;

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) existingAlert.remove();
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);
            setTimeout(() => { if (alert.parentNode) alert.remove(); }, 4000);
        }

        // API è«‹æ±‚å°è£
        async function apiFetch(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, credentials: 'include' });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP éŒ¯èª¤: ${response.status} ${response.statusText}` }));
                    throw new Error(errorData.message || errorData.error);
                }
                if (response.status === 204) return null;
                return await response.json();
            } catch (error) {
                showAlert(error.message, 'error');
                throw error;
            }
        }

        // ç™»å…¥åŠŸèƒ½
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (!username || !password) return showAlert('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼ï¼', 'error');
            try {
                const data = await apiFetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (data.status === 'success') {
                    showAlert(`ç™»å…¥æˆåŠŸï¼æ­¡è¿ ${data.username}`, 'success');
                    updateAuthStatus(true, data.username);
                    await loadAllData();
                    await loadGitHubConfig();
                }
            } catch (error) { 
                console.error("Login failed:", error); 
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            try {
                await apiFetch('/api/logout', { method: 'POST' });
                showAlert('å·²ç™»å‡ºï¼', 'success');
                await checkAuthentication();
            } catch (error) { 
                console.error("Logout failed:", error); 
            }
        }
        
        // æª¢æŸ¥èªè­‰ç‹€æ…‹
        async function checkAuthentication() {
            try {
                const data = await apiFetch('/api/auth/status');
                updateAuthStatus(data.authenticated, data.username);
                if (data.authenticated) {
                    await loadAllData();
                    await loadGitHubConfig();
                } else {
                    hackData = [];
                    updateAllVisuals();
                }
            } catch (error) {
                updateAuthStatus(false);
                hackData = [];
                updateAllVisuals();
            }
        }
        
        // æ›´æ–°èªè­‰ç‹€æ…‹
        function updateAuthStatus(isAuthenticated, username = '') {
            console.log('updateAuthStatus called', isAuthenticated, username);
            const authStatus = document.getElementById('authStatus');
            const mainContent = document.getElementById('mainContent');
            if (isAuthenticated) {
                authStatus.className = 'auth-status authenticated';
                authStatus.textContent = `âœ… å·²ç™»å…¥: ${username}`;
                mainContent.classList.remove('locked');
            } else {
                authStatus.className = 'auth-status not-authenticated';
                authStatus.textContent = 'âŒ æœªç™»å…¥';
                mainContent.classList.add('locked');
            }
        }

        // è¼‰å…¥æ‰€æœ‰æ•¸æ“š
        async function loadAllData() {
            try {
                hackData = await apiFetch('/api/data');
                updateAllVisuals();
            } catch (error) {
                hackData = [];
                updateAllVisuals();
            }
        }

        // æ›´æ–°æ‰€æœ‰è¦–è¦ºå…ƒç´ 
        function updateAllVisuals() {
            updateStats();
            updateDataTable();
        }
        
        // æ–°å¢ Hack æ•¸æ“š
        async function addHackData() {
            const newRecord = { hackCount: parseInt(document.getElementById('hackCount').value) || 1 };
            itemColumns.forEach(col => newRecord[col] = parseInt(document.getElementById(col).value) || 0);
            try {
                await apiFetch('/api/data', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(newRecord) 
                });
                showAlert('è³‡æ–™å·²æ–°å¢ï¼', 'success');
                await loadAllData();
            } catch (error) {
                console.error('Add hack data failed:', error);
            }
        }
        
        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            if (!hackData || hackData.length === 0) {
                statsGrid.innerHTML = '<div class="stat-card"><div class="stat-value">0</div><div class="stat-label">å°šç„¡æ•¸æ“š</div></div>';
                return;
            }

            const totalHacks = hackData.reduce((sum, rec) => sum + (rec['hackCount'] || 0), 0);
            const totalItems = hackData.reduce((sum, rec) => sum + itemColumns.reduce((iSum, col) => iSum + (rec[col] || 0), 0), 0);
            const avgItemsPerHack = totalHacks > 0 ? (totalItems / totalHacks) : 0;
            const totalRecords = hackData.length;

            statsGrid.innerHTML = `
                <div class="stat-card"><div class="stat-value">${totalHacks}</div><div class="stat-label">ç¸½ Hack æ¬¡æ•¸</div></div>
                <div class="stat-card"><div class="stat-value">${totalItems}</div><div class="stat-label">ç¸½ç‰©è³‡æ•¸é‡</div></div>
                <div class="stat-card"><div class="stat-value">${avgItemsPerHack.toFixed(2)}</div><div class="stat-label">å¹³å‡æ¯æ¬¡ Hack ç‰©è³‡é‡</div></div>
                <div class="stat-card"><div class="stat-value">${totalRecords}</div><div class="stat-label">ç¸½è¨˜éŒ„ç­†æ•¸</div></div>
            `;
        }
        
        // æ›´æ–°æ•¸æ“šè¡¨æ ¼
        function updateDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            if (!hackData || hackData.length === 0) return;
            
            const totalHacks = hackData.reduce((sum, rec) => sum + (rec['hackCount'] || 0), 0);
            const totalItems = hackData.reduce((sum, rec) => sum + itemColumns.reduce((iSum, col) => iSum + (rec[col] || 0), 0), 0);
            
            itemColumns.forEach(column => {
                const total = hackData.reduce((sum, rec) => sum + (rec[column] || 0), 0);
                if (total > 0) {
                    const percentage = totalItems > 0 ? ((total / totalItems) * 100).toFixed(2) : '0.00';
                    const avgPerHack = totalHacks > 0 ? (total / totalHacks).toFixed(2) : '0.00';
                    const row = `<tr><td>${itemNames[column]}</td><td>${total}</td><td>${percentage}%</td><td>${avgPerHack}</td></tr>`;
                    tbody.innerHTML += row;
                }
            });
        }

        // ä¸Šå‚³æœ¬åœ° CSV æª”æ¡ˆ
        async function uploadLocalCSV() {
            alert('uploadLocalCSV called');
            const fileInput = document.getElementById('csvFile');
            if (!fileInput.files || fileInput.files.length === 0) {
                showAlert('è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„ CSV æª”æ¡ˆ', 'error');
                return;
            }
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch(`${API_BASE_URL}/api/upload_csv`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showAlert('CSV å·²æˆåŠŸä¸Šå‚³ä¸¦è¼‰å…¥', 'success');
                    hackData = data.data;
                    updateAllVisuals();
                } else {
                    showAlert(data.message || 'CSV ä¸Šå‚³å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('CSV ä¸Šå‚³å¤±æ•—: ' + error.message, 'error');
                console.error('Upload CSV failed:', error);
            }
        }
        window.uploadLocalCSV = uploadLocalCSV;
        
        // GitHub è¨­å®šç›¸é—œåŠŸèƒ½
        async function loadGitHubConfig() {
            showAlert('GitHub è¨­å®šè¼‰å…¥åŠŸèƒ½å°šæœªå¯¦ä½œ', 'warning');
        }

        async function saveGitHubConfig() {
            showAlert('GitHub è¨­å®šå„²å­˜åŠŸèƒ½å°šæœªå¯¦ä½œ', 'warning');
        }

        async function syncFromGitHub() {
            try {
                const res = await fetch('/api/github/sync', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showAlert('å·²å¾ GitHub åŒæ­¥æœ€æ–°è³‡æ–™ï¼', 'success');
                    await loadAllData();
                } else {
                    showAlert(data.message || 'åŒæ­¥å¤±æ•—', 'error');
                }
            } catch (error) {
                showAlert('åŒæ­¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        async function uploadToGitHub() {
            try {
                const res = await fetch('/api/github/upload', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showAlert('è³‡æ–™å·²ä¸Šå‚³åˆ° GitHubï¼', 'success');
                } else {
                    showAlert('ä¸Šå‚³å¤±æ•—ï¼š' + (data.message || ''), 'error');
                }
            } catch (e) {
                showAlert('ä¸Šå‚³å¤±æ•—ï¼š' + e, 'error');
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', checkAuthentication);
    </script>
</body>
</html>